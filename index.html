<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BDR 랭킹 - 일반부</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<meta name="color-scheme" content="dark" />
<style>
  :root{--surface:#0e141c;--card:#131a24;--muted:#94a3b8;--accent:#ffd54a}
  html,body{background:var(--surface)}
  .surface{background:var(--surface)} .card{background:var(--card)} .muted{color:var(--muted)} .accent{color:var(--accent)}
  .shadow-smooth{box-shadow:0 10px 30px rgba(0,0,0,.35)} .num{font-variant-numeric:tabular-nums}
  body{font-size:17px; line-height:1.55; -webkit-font-smoothing:antialiased; text-rendering:geometricPrecision}
  .card{border:1px solid #1f2a3a}
  .city-line{font-size:1.125rem}
  .title{letter-spacing:.2px}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* 컨트롤 폰트 +3px */
  .control-lg{font-size:20px}
  .control-label{font-size:18px}

  /* 랭킹변화 배지(웹) – 중앙 정렬 */
  .badge{border-radius:9999px;border:1px solid rgba(148,163,184,.34);line-height:1;font-weight:800;font-size:1rem}
  .badge-grid{display:inline-flex;align-items:center;justify-content:center;gap:6px;height:28px;padding:4px 12px}
  .badge-pill{display:inline-flex;align-items:center;justify-content:center;height:28px;padding:4px 12px}
  .badge-up{background:rgba(239,68,68,.18);color:#fca5a5;border-color:rgba(239,68,68,.55)}
  .badge-down{background:rgba(59,130,246,.18);color:#93c5fd;border-color:rgba(59,130,246,.55)}
  .badge-stay{background:rgba(148,163,184,.14);color:#cbd5e1;border-color:rgba(148,163,184,.34)}
  .ico{width:16px;height:16px;position:relative;display:inline-block;vertical-align:middle}
  .ico::before,.ico::after{content:"";position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:currentColor;border-radius:2px}
  .ico.plus::before,.ico.minus::before,.ico.dash::before{width:14px;height:2px}
  .ico.plus::after{width:2px;height:14px}
  .badge-grid .n{display:flex;align-items:center;height:18px;line-height:1}

  /* 점수 변화 색 */
  .score-up{color:#f87171;font-weight:700}
  .score-down{color:#60a5fa;font-weight:700}
  .score-same{color:#94a3b8;font-weight:600}

  /* Top-3 강조 */
  .top1{border:1.5px solid rgba(255,215,0,.55);background:linear-gradient(180deg,rgba(255,215,0,.10),transparent 50%),var(--card)}
  .top2{border:1.5px solid rgba(192,192,192,.55);background:linear-gradient(180deg,rgba(192,192,192,.10),transparent 50%),var(--card)}
  .top3{border:1.5px solid rgba(205,127,50,.55);background:linear-gradient(180deg,rgba(205,127,50,.10),transparent 50%),var(--card)}
  .medal{font-weight:900;letter-spacing:.02em}.medal-g{color:#ffd700}.medal-s{color:#c0c0c0}.medal-b{color:#cd7f32}

  /* 캡처(다운로드)도 동일 중앙 정렬 */
  .ex-root{width:1080px;height:1350px;background:#0e141c;color:#fff;padding:24px;box-sizing:border-box;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Pretendard,sans-serif;-webkit-font-smoothing:antialiased;text-rendering:geometricPrecision}
  .ex-header{display:flex;flex-direction:column;align-items:center;margin-bottom:16px}
  .ex-row{display:flex;align-items:flex-end;justify-content:space-between;width:100%}
  .ex-title{font-size:40px;font-weight:800;letter-spacing:.2px}
  .ex-date{font-size:20px;color:#94a3b8;font-weight:700}
  .ex-fit{width:100%;overflow:hidden;display:flex;justify-content:center}
  .ex-content{width:100%;transform-origin:top center}
  .ex-list{display:flex;flex-direction:column;gap:8px}
  .ex-card{background:#131a24;border:1px solid #1f2a3a;border-radius:16px;padding:14px 18px}
  .ex-grid{display:grid;grid-template-columns:80px 200px 1fr 220px;align-items:center;column-gap:16px}
  .ex-badge{border-radius:9999px;border:1px solid rgba(148,163,184,.34);font-size:18px;font-weight:800;line-height:1}
  .ex-badge.up{background:rgba(239,68,68,.18);color:#fca5a5;border-color:rgba(239,68,68,.55)}
  .ex-badge.down{background:rgba(59,130,246,.18);color:#93c5fd;border-color:rgba(59,130,246,.55)}
  .ex-badge.stay{background:rgba(148,163,184,.14);color:#cbd5e1;border-color:rgba(148,163,184,.34)}
  .ex-gridbadge{display:inline-flex;align-items:center;justify-content:center;gap:6px;height:28px;padding:4px 12px}
  .ex-pill{display:inline-flex;align-items:center;justify-content:center;height:28px;padding:4px 12px}
  .ex-ico{width:16px;height:16px;position:relative;display:inline-block;vertical-align:middle}
  .ex-ico::before,.ex-ico::after{content:"";position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:currentColor;border-radius:2px}
  .ex-ico.plus::before,.ex-ico.minus::before,.ex-ico.dash::before{width:14px;height:2px}
  .ex-ico.plus::after{width:2px;height:14px}
  .ex-num{display:flex;align-items:center;height:18px;line-height:1}

  /* 커스텀 멀티셀렉트(지역) – 한 열, 큰 글자 */
  .dropdown-panel{position:absolute;z-index:50;width:100%;margin-top:.5rem;border-radius:12px;background:#0b111a;border:1px solid #1f2a3a;box-shadow:0 10px 25px rgba(0,0,0,.45)}
  .region-item{display:flex;align-items:center;gap:.9rem;padding:.8rem 1rem;border-radius:.75rem;cursor:pointer}
  .region-item:hover{background:#0f1723}
  .region-item input{width:20px;height:20px}
  .region-item span{font-size:1.1rem}

  /* 모달(랭킹 범위 선택) */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(1px);display:flex;align-items:center;justify-content:center;z-index:60}
  .modal-card{background:#0b111a;border:1px solid #1f2a3a;border-radius:14px;width:min(92vw,520px);padding:20px}
  .btn-strong{font-size:18px;padding:.65rem 1rem;border-radius:.75rem}
</style>
</head>
<body class="min-h-screen surface text-white antialiased">
<div class="max-w-6xl mx-auto px-4 py-6">

  <!-- 헤더 -->
  <div class="flex flex-col items-center w-full">
    <img src="BDR(배경없음).png" alt="BDR Logo" class="h-20 object-contain mb-2" crossOrigin="anonymous">
    <div class="flex items-end justify-between w-full">
      <h1 class="title text-3xl sm:text-4xl font-bold">BDR 랭킹 - 일반부</h1>
      <span id="lastUpdated" class="text-lg font-semibold muted"></span>
    </div>
  </div>

  <!-- 컨트롤: 한 줄 정렬 (+3px) -->
  <div class="grid grid-cols-1 sm:grid-cols-5 gap-3 mt-4 items-center">
    <input id="search" type="search" placeholder="팀명/지역 검색…" class="control-lg sm:col-span-2 rounded-xl bg-[#0b111a] border border-[#1f2a3a] px-4 py-3 outline-none focus:ring-2 focus:ring-indigo-500" />

    <!-- 지역 드롭다운(다중 선택, 한 열/큰 글자) -->
    <div class="sm:col-span-2 relative">
      <button id="regionToggle" class="control-lg w-full rounded-xl bg-[#0b111a] border border-[#1f2a3a] px-4 py-3 text-left flex items-center justify-between">
        <span id="regionLabel" class="truncate control-label muted">지역 필터 (다중 선택)</span>
        <svg width="18" height="18" viewBox="0 0 24 24"><path fill="#94a3b8" d="M7 10l5 5 5-5z"/></svg>
      </button>
      <div id="regionPanel" class="hidden dropdown-panel p-3">
        <div id="regionList" class="flex flex-col gap-1"></div>
        <div class="mt-4 flex items-center justify-between">
          <button id="regionReset" class="btn-strong bg-[#0b111a] border border-[#1f2a3a]">전체 해제</button>
          <button id="regionApply" class="btn-strong bg-indigo-600 hover:bg-indigo-500">적용</button>
        </div>
      </div>
    </div>

    <!-- 모달로 범위 선택 → 다운로드 -->
    <button id="btnExport" class="control-lg sm:col-span-1 rounded-xl bg-[#0b111a] border border-[#1f2a3a] px-4 py-3 hover:bg-[#131a24]">
      이미지 다운로드
    </button>
  </div>

  <p class="control-lg text-indigo-200/80 text-right -mt-1">
    ※ 지역 드롭다운에서 여러 지역을 선택하면 해당 지역들의 랭킹을 함께 볼 수 있습니다.
  </p>

  <!-- 리스트 -->
  <div id="list" class="space-y-3"></div>
  <div class="flex items-center justify-end">
    <div class="muted text-sm">총 <span id="rowCount"></span>개 팀</div>
  </div>

  <!-- 상태/오류 -->
  <div id="status" class="flex items-center gap-3 text-sm muted mt-3">
    <div style="width:22px;height:22px;border-radius:9999px;border:3px solid #1f2a3a;border-top-color:#60a5fa;animation:spin .9s linear infinite"></div>
    <span>데이터 불러오는 중…</span>
  </div>
  <div id="error" class="hidden text-sm text-red-400 mt-2"></div>
</div>

<!-- 모달(랭킹 범위 선택) -->
<div id="rangeModal" class="hidden"></div>

<script>
  /* 데이터 경로(요청 반영) */
  const LOCAL_XLSX_URL = "https://raw.githubusercontent.com/cobby8/BDR-ranking-d/main/division_rank.xlsx";

  let BASE=[], FILTERED=[], LOCAL_RANK_MAP=null;
  const list=document.getElementById('list'), search=document.getElementById('search'),
        rowCount=document.getElementById('rowCount'),
        statusEl=document.getElementById('status'), errorEl=document.getElementById('error'),
        lastUpdated=document.getElementById('lastUpdated');

  // region dropdown
  const regionToggle=document.getElementById('regionToggle');
  const regionPanel=document.getElementById('regionPanel');
  const regionList=document.getElementById('regionList');
  const regionLabel=document.getElementById('regionLabel');
  const regionReset=document.getElementById('regionReset');
  const regionApply=document.getElementById('regionApply');
  const selectedRegions = new Set();

  function formatDate(d){const z=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}년 ${z(d.getMonth()+1)}월 ${z(d.getDate())}일`;}
  lastUpdated.textContent=formatDate(new Date());

  const MAP_CANDIDATES={
    rank:["랭킹","순위","rank"], team:["팀","팀명","name","team","클럽"],
    city:["지역","연고","도시","city","location"],
    score:["점수","score","포인트","point"],
    move:["랭킹 변화","증감","변동","delta","updown","전주대비","전월대비"],
    scoreChange:["점수 변화","점수 증감","score change","score diff","score_delta"]
  };
  const pick=(keys,cands)=>{for(const c of cands){const f=keys.find(k=>(k||"").toLowerCase().includes(c.toLowerCase())); if(f) return f} return null}
  const byRankClass=r=>r===1?'top1':r===2?'top2':r===3?'top3':'';
  const medal=r=>r===1?'<span class="medal-g">GOLD</span>':r===2?'<span class="medal-s">SILVER</span>':r===3?'<span class="medal-b">BRONZE</span>':'';

  /* 지역 정렬 우선순위: 서울→경기→인천→강원도→충청도→전라도→경상도→제주도 */
  function regionOrderKey(name){
    const n=(name||'').trim();
    const starts=(p)=>n.startsWith(p);
    if(n==='서울'||starts('서울')) return 1;
    if(n==='경기'||starts('경기')) return 2;
    if(n==='인천'||starts('인천')) return 3;
    if(n.includes('강원')) return 4;
    if(n.includes('충청')||n.startsWith('충남')||n.startsWith('충북')||n.startsWith('대전')||n.startsWith('세종')) return 5;
    if(n.includes('전라')||n.startsWith('전남')||n.startsWith('전북')||n.startsWith('광주')) return 6;
    if(n.includes('경상')||n.startsWith('경남')||n.startsWith('경북')||n.startsWith('부산')||n.startsWith('대구')||n.startsWith('울산')) return 7;
    if(n.includes('제주')) return 8;
    return 9;
  }

  function movementBadge(m){
    const n=Number(m);
    if(Number.isNaN(n) || n===0){
      return `<span class="badge badge-stay badge-pill" aria-label="변동 없음"><i class="ico dash"></i></span>`;
    }
    if(n>0){
      return `<span class="badge badge-up badge-grid"><i class="ico plus"></i><span class="n num">${n}</span></span>`;
    }
    return `<span class="badge badge-down badge-grid"><i class="ico minus"></i><span class="n num">${Math.abs(n)}</span></span>`;
  }
  function scoreChangeBadge(val){
    if(val===null || val===undefined || val==="" || Number(val)===0) return `<span class="score-same">-</span>`;
    const num=Number(val); if(Number.isNaN(num)) return `<span class="score-same">-</span>`;
    if(num>0) return `<span class="score-up">+${num}</span>`;
    if(num<0) return `<span class="score-down">-${Math.abs(num)}</span>`;
    return `<span class="score-same">-</span>`;
  }
  function buildLocalRankMap(){
    const subset = FILTERED.slice().sort((a,b)=> (a.rank??Infinity)-(b.rank??Infinity));
    const map = new Map();
    subset.forEach((it,idx)=>map.set((it.team||'')+"||"+(it.city||''), idx+1));
    LOCAL_RANK_MAP = map;
  }
  function regionalBadge(team,city){
    return LOCAL_RANK_MAP?`<span class="chip chip-region">지역 랭킹 ${LOCAL_RANK_MAP.get((team||'')+"||"+(city||''))||''}위</span>`:'';
  }
  function cardHTML(it){
    const scoreText = isNaN(Number(it.score)) ? (it.score??'') : Number(it.score).toFixed(1);
    return `
    <div class="card shadow-smooth rounded-2xl px-5 sm:px-7 py-5 ${byRankClass(it.rank)}">
      <div class="grid grid-cols-12 items-center gap-4">
        <div class="col-span-2 sm:col-span-1 flex flex-col items-start">
          <div class="text-3xl sm:text-4xl font-extrabold num">${it.rank}</div>
          <div class="text-[11px] mt-1">${medal(it.rank)}</div>
        </div>
        <div class="col-span-3 sm:col-span-3 flex flex-col items-start gap-1.5">
          ${movementBadge(it.move)}
          ${regionalBadge(it.team, it.city)}
        </div>
        <div class="col-span-4 sm:col-span-5">
          <div class="text-2xl font-semibold">${it.team}</div>
          <div class="city-line muted mt-0.5">${it.city || ''}</div>
        </div>
        <div class="col-span-3 sm:col-span-3 text-right">
          <div class="text-3xl sm:text-4xl font-extrabold accent num">${scoreText}</div>
          <div class="mt-1.5 flex justify-end items-baseline gap-1.5">
            <span class="text-xl">${scoreChangeBadge(it.scoreChange)}</span>
            <span class="text-xl muted">점</span>
          </div>
        </div>
      </div>
    </div>`;
  }
  function renderScreen(){
    rowCount.textContent=FILTERED.length;
    list.innerHTML=FILTERED.map(cardHTML).join('');
  }

  /* 지역 드롭다운 구성(정렬 순서 반영) */
  function buildRegionDropdown(){
    let regions = Array.from(new Set(BASE.map(b => (b.city||'').trim()).filter(Boolean)));
    regions.sort((a,b)=>{
      const oa=regionOrderKey(a), ob=regionOrderKey(b);
      return oa===ob ? a.localeCompare(b,'ko') : oa-ob;
    });
    regionList.innerHTML = regions.map(r => `
      <label class="region-item">
        <input type="checkbox" value="${r}" class="regionOpt">
        <span>${r}</span>
      </label>
    `).join('');
  }
  function updateRegionLabel(){
    const regs = Array.from(selectedRegions);
    if(regs.length===0){ regionLabel.textContent='지역 필터 (다중 선택)'; return; }
    if(regs.length<=2){ regionLabel.textContent = regs.join(', '); return; }
    regionLabel.textContent = regs.slice(0,2).join(', ') + ` 외 ${regs.length-2}`;
  }
  function getFilteredByRegions(data){
    if(selectedRegions.size===0) return data;
    return data.filter(d => selectedRegions.has((d.city||'').trim()));
  }
  function applyFilter(){
    const q=(search.value||'').toLowerCase();
    const regionFiltered = getFilteredByRegions(BASE);
    FILTERED = regionFiltered.filter(it=>{
      const hay=((it.team||'')+' '+(it.city||'')).toLowerCase();
      return !q || hay.includes(q);
    });
    buildLocalRankMap();
    renderScreen();
  }

  // 드롭다운 토글/동작
  function openRegionPanel(){ regionPanel.classList.remove('hidden'); }
  function closeRegionPanel(){ regionPanel.classList.add('hidden'); }
  regionToggle.addEventListener('click', (e)=>{ e.stopPropagation(); regionPanel.classList.toggle('hidden'); });
  document.addEventListener('click', ()=>{ if(!regionPanel.classList.contains('hidden')) closeRegionPanel(); });
  regionPanel.addEventListener('click', (e)=> e.stopPropagation()); // 내부 클릭시 닫힘 방지

  regionReset.addEventListener('click', (e)=>{
    e.preventDefault();
    selectedRegions.clear();
    regionList.querySelectorAll('.regionOpt').forEach(i=>i.checked=false);
    updateRegionLabel();
  });
  regionApply.addEventListener('click', (e)=>{
    e.preventDefault();
    applyFilter(); closeRegionPanel();
  });
  regionList.addEventListener('change', (e)=>{
    if(e.target && e.target.classList.contains('regionOpt')){
      const v=e.target.value;
      if(e.target.checked) selectedRegions.add(v); else selectedRegions.delete(v);
      updateRegionLabel();
    }
  });

  search.addEventListener('input', applyFilter);

  /* 데이터 로드 */
  async function loadLocal(){
    statusEl.classList.remove('hidden'); errorEl.classList.add('hidden'); errorEl.textContent='';
    try{
      const res=await fetch(LOCAL_XLSX_URL,{cache:'no-store',mode:'cors'});
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const ab=await res.arrayBuffer();
      const wb=XLSX.read(new Uint8Array(ab),{type:'array'});
      const ws=wb.Sheets[wb.SheetNames[0]];
      const rows=XLSX.utils.sheet_to_json(ws,{defval:'',raw:true});
      if(!rows.length) throw new Error('시트가 비어있습니다.');
      const keys=Object.keys(rows[0]||{});
      const map={
        rank:pick(keys,MAP_CANDIDATES.rank), team:pick(keys,MAP_CANDIDATES.team),
        city:pick(keys,MAP_CANDIDATES.city), score:pick(keys,MAP_CANDIDATES.score),
        move:pick(keys,MAP_CANDIDATES.move), scoreChange:pick(keys,MAP_CANDIDATES.scoreChange)
      };
      BASE=rows.map((r,i)=>({
        rank:map.rank?Number(r[map.rank])||(i+1):(i+1),
        team:map.team?r[map.team]:'', city:(map.city?r[map.city]:'').toString().trim(),
        score:map.score?r[map.score]:'', move:map.move?(r[map.move]===''?0:r[map.move]):0,
        scoreChange:map.scoreChange?(r[map.scoreChange]||0):null
      }));

      buildRegionDropdown(); updateRegionLabel();

      FILTERED=[...BASE];
      buildLocalRankMap();
      renderScreen();

      statusEl.classList.add('hidden');
    }catch(err){
      statusEl.classList.add('hidden');
      errorEl.classList.remove('hidden');
      errorEl.textContent=`데이터 로드 오류: ${err.message}`;
    }
  }
  loadLocal();

  /* 모달(랭킹 범위 선택) + 다운로드 */
  function buildExportRanges(){
    const total=FILTERED.length, pageSize=10;
    const pages=Math.ceil(total/pageSize)||1;
    return Array.from({length:pages},(_,i)=>{
      const s=i*pageSize+1, e=Math.min((i+1)*pageSize,total);
      return {label:`${s}–${e}위`, value:`${s}-${e}`};
    });
  }
  function openRangeModal(){
    const ranges = buildExportRanges();
    if(!ranges.length){ alert('다운로드할 팀이 없습니다. 필터를 확인하세요.'); return; }
    const modal = document.getElementById('rangeModal');
    modal.innerHTML = `
      <div class="modal-backdrop" role="dialog" aria-modal="true">
        <div class="modal-card" onclick="event.stopPropagation()">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold">이미지 다운로드</h2>
            <button id="mdClose" class="btn-strong bg-[#0b111a] border border-[#1f2a3a]">닫기</button>
          </div>
          <div class="space-y-3">
            <label class="text-sm muted">랭킹 범위(10팀 단위)</label>
            <select id="mdRange" class="control-lg w-full rounded-lg bg-[#0b111a] border border-[#1f2a3a] px-3 py-2">
              ${ranges.map(r=>`<option value="${r.value}">${r.label}</option>`).join('')}
            </select>
          </div>
          <div class="mt-4 flex items-center justify-end gap-2">
            <button id="mdCancel" class="btn-strong bg-[#0b111a] border border-[#1f2a3a]">취소</button>
            <button id="mdDownload" class="btn-strong bg-indigo-600 hover:bg-indigo-500">다운로드</button>
          </div>
        </div>
      </div>`;
    modal.classList.remove('hidden');

    const close=()=>modal.classList.add('hidden');
    modal.querySelector('#mdClose').onclick=close;
    modal.querySelector('#mdCancel').onclick=close;
    modal.querySelector('.modal-backdrop').onclick=close;

    modal.querySelector('#mdDownload').onclick=async ()=>{
      const val=(document.getElementById('mdRange').value||'1-10');
      await doExport(val);
      close();
    };
  }
  document.getElementById('btnExport').addEventListener('click', openRangeModal);

  async function doExport(rangeStr){
    const [s,e]=(rangeStr||'1-10').split('-').map(n=>parseInt(n,10));
    const startIdx=Math.max(0,(s||1)-1), endIdx=Math.min(FILTERED.length,(e||10));
    const slice=FILTERED.slice(startIdx,endIdx);

    const stage=document.createElement('div'); stage.className='ex-root';
    stage.innerHTML=`
      <div class="ex-header" id="exHeader">
        <div class="ex-row">
          <div class="ex-title">BDR 랭킹 - 일반부</div>
          <div class="ex-date">${lastUpdated.textContent}</div>
        </div>
      </div>
      <div class="ex-fit" id="exFit">
        <div class="ex-content" id="exContent">
          <div id="exportList" class="ex-list"></div>
        </div>
      </div>`;
    document.body.appendChild(stage);

    stage.querySelector('#exportList').innerHTML=slice.map(it=>{
      const n=Number(it.move);
      const scoreText=isNaN(Number(it.score))?(it.score??''):Number(it.score).toFixed(1);
      const diff=it.scoreChange;
      const diffHTML=(!diff&&diff!==0)||Number(diff)===0?`<span class="ex-same">-</span>`:(Number(diff)>0?`<span class="ex-up">+${Number(diff)}</span>`:`<span class="ex-down">-${Math.abs(Number(diff))}</span>`);
      const moveHTML=Number.isNaN(n)||n===0?`<span class="ex-badge stay ex-pill"><i class="ex-ico dash"></i></span>`:(n>0?`<span class="ex-badge up ex-gridbadge"><i class="ex-ico plus"></i><span class="ex-num num">${n}</span></span>`:`<span class="ex-badge down ex-gridbadge"><i class="ex-ico minus"></i><span class="ex-num num">${Math.abs(n)}</span></span>`);
      return `
      <div class="ex-card ${byRankClass(it.rank)}">
        <div class="ex-grid">
          <div>
            <div class="ex-rank-num num">${it.rank}</div>
            <div class="text-[11px] mt-1">${it.rank===1?'<span class="medal-g">GOLD</span>':it.rank===2?'<span class="medal-s">SILVER</span>':it.rank===3?'<span class="medal-b">BRONZE</span>':''}</div>
          </div>
          <div class="ex-badges">${moveHTML}</div>
          <div>
            <div class="ex-team-name">${it.team}</div>
            <div class="ex-city">${it.city||''}</div>
          </div>
          <div class="text-right">
            <div class="ex-score-val num">${scoreText}</div>
            <div class="ex-score-diff num">${diffHTML}<span class="ex-same">점</span></div>
          </div>
        </div>
      </div>`;
    }).join('');

    const headerH=stage.querySelector('#exHeader').offsetHeight;
    const rootH=stage.clientHeight;
    const guard=16;
    const fitH=rootH-headerH-guard;
    stage.querySelector('#exFit').style.height=fitH+'px';

    const content=stage.querySelector('#exContent');
    const contentH=content.scrollHeight;
    const scale=Math.min(1,(fitH-6)/contentH);
    content.style.transform=`scale(${scale})`;
    content.style.height=`${contentH*scale}px`;

    try{
      const canvas=await html2canvas(stage,{backgroundColor:'#0e141c',useCORS:true,allowTaint:false,width:1080,height:1350,windowWidth:1080,windowHeight:1350,scale:2});
      const a=document.createElement('a'); a.download=`bdr_ranking_${s||1}-${e||10}_${new Date().toISOString().slice(0,10)}.png`; a.href=canvas.toDataURL('image/png'); a.click();
    }catch(e){ alert('이미지 저장 오류: '+e.message); }
    finally{ stage.remove(); }
  }
</script>
</body>
</html>
